#cloud-config
package_update: false
package_upgrade: false
# Nginx removed from this list
packages:
  - curl

users:
  - name: ubuntu
    groups: users, admin
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    plain_text_passwd: ubuntu
    lock_passwd: false
    ssh_authorized_keys:
      - ${SSH_PUBLIC_KEY}

runcmd:
  # --- Installation of NVM, Node.js, PM2 and n8n ---
  - |
    sudo -i -u ubuntu bash <<'EOF'
    echo "Installing NVM (Node Version Manager)..."
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash

    # Load NVM into current session
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

    echo "Installing latest LTS Node.js version..."
    nvm install --lts

    echo "Installing PM2 and n8n..."
    npm install -g pm2 n8n

    echo "Creating configuration file for n8n..."
    mkdir -p ~/.n8n
    # IMPORTANT: 'host' changed to '0.0.0.0' to listen on all interfaces
    # Added port :5678 to webhookUrl
    echo '{
      "host": "0.0.0.0",
      "port": 5678,
      "protocol": "http",
      "path": "/",
      "webhookUrl": "http://${DOMAIN}:5678/"
    }' > ~/.n8n/config.json

    echo "Starting n8n using PM2..."
    pm2 start n8n
    
    echo "Saving PM2 process list..."
    pm2 save
    EOF

  # --- PM2 system startup configuration ---
  - echo "Configuring PM2 for automatic startup..."
  - 'PM2_STARTUP_CMD=$(sudo -i -u ubuntu pm2 startup | tail -n 1)'
  - "echo \"Running startup command: $PM2_STARTUP_CMD\""
  - "$PM2_STARTUP_CMD"

